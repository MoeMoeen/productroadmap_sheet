name: Sync to Google Drive

on:
  push: 
    branches:
      - main

jobs:
  upload: 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses:  actions/checkout@v4

      - name: Zip Repository
        run: zip -r repository.zip . -x "*.git*"

      - name: Upload to Drive
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS_DATA }}
          FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          echo "$GDRIVE_CREDENTIALS" > credentials.json
          
          pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
          
          python - <<EOF
          import os
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          from google.oauth2 import service_account

          SCOPES = ['https://www.googleapis.com/auth/drive']
          SERVICE_ACCOUNT_FILE = 'credentials.json'

          creds = service_account. Credentials.from_service_account_file(SERVICE_ACCOUNT_FILE, scopes=SCOPES)
          service = build('drive', 'v3', credentials=creds)

          folder_id = os.environ['FOLDER_ID']
          
          # Delete existing file with same name
          query = f"name='repository.zip' and '{folder_id}' in parents and trashed=false"
          results = service.files().list(q=query, supportsAllDrives=True, includeItemsFromAllDrives=True).execute()
          items = results.get('files', [])
          
          for item in items:
            try:
              service.files().delete(fileId=item['id'], supportsAllDrives=True).execute()
              print(f"Deleted old file: {item['id']}")
            except Exception as e:
              print(f"Error deleting file {item['id']}: {e}")

          # Upload new file
          file_metadata = {'name': 'repository.zip', 'parents': [folder_id]}
          media = MediaFileUpload('repository.zip', mimetype='application/zip')
          
          file = service.files().create(
              body=file_metadata, 
              media_body=media, 
              fields='id',
              supportsAllDrives=True
          ).execute()
          print(f"Uploaded file ID: {file.get('id')}")
          EOF
          
          rm -f credentials.json