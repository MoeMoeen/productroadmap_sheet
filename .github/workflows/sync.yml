name: Sync to Google Drive

on:
  push:
    branches:
      - main

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Zip Repository
        run: zip -r repository.zip . -x "*.git*"

      - name: Upload to Drive
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS_DATA }}
          FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          # Create a temporary file for credentials
          echo "$GDRIVE_CREDENTIALS" > credentials.json
          
          # Use a Python script (built-in) to handle the upload
          # This avoids the "Repository Not Found" error entirely
          pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
          
          python - <<EOF
          import os
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          from google.oauth2 import service_account

          SCOPES = ['https://www.googleapis.com/auth/drive.file']
          SERVICE_ACCOUNT_FILE = 'credentials.json'

          creds = service_account.Credentials.from_service_account_file(SERVICE_ACCOUNT_FILE, scopes=SCOPES)
          service = build('drive', 'v3', credentials=creds)

          file_metadata = {'name': 'repository.zip', 'parents': ['$FOLDER_ID']}
          media = MediaFileUpload('repository.zip', mimetype='application/zip')
          
          file = service.files().create(body=file_metadata, media_body=media, fields='id').execute()
          print(f"File ID: {file.get('id')}")
          EOF
